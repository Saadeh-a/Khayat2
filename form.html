<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<style>
:root {
  --side-gutter: 3%;            
  --hero-height: 200px;         
  --hero-offset: 18px;          
}
html { font-size: 32px; }
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
  background: #d9d9d9;
  color: #222;
  line-height: 1.4;
  padding-top: calc(var(--hero-offset) + var(--hero-height));
}
#wrap {
  padding: 0 var(--side-gutter);
  width: calc(100% - var(--side-gutter) * 2);
  margin: 0 auto;
}
#hero {
  position: fixed;
  top: var(--hero-offset);
  left: var(--side-gutter);
  width: calc(100% - var(--side-gutter) * 2);
  height: var(--hero-height);
  background: #000;
  z-index: 1000;
  box-sizing: border-box;
}
#logoAndTitleContainer {
  position: absolute;
  left: 8px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  align-items: center;
  direction: ltr;               
}
#logoAndTitleContainer img {
  height: 80px;                 
  margin-right: 650px;           
  flex-shrink: 0;
}
#hero-title {
  font-size: 36px;
  font-weight: 600;
  color: #fff;
  white-space: nowrap;
  direction: ltr;               
  text-align: left;
}
#langToggle {
  position: absolute;
  right: 14px;
  bottom: 14px;
  display: flex;
  gap: 8px;
  direction: ltr;               
}
.lang-btn {
  padding: 4px 14px;
  border: 2px solid #fff;
  border-radius: 8px;
  background: #fff;
  color: #000;
  font-weight: 600;
  font-size: .9rem;
  user-select: none;
}
.lang-btn.active {
  background: #1a73e8;
  color: #fff;
  border-color: #1a73e8;
}
#tabBar {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1px;
  background: #000;
  margin-top: 30px;
}
.tab {
  display: flex; align-items: center; justify-content: center;
  height: 60px; padding: 0 4px;
  background: #000; color: #fff;
  font-size: .78rem; cursor: pointer; user-select: none;
}
.tab.active            { background: #fff;    color: #000; font-weight: 600; }
.tab.done:not(.active) { background: #1a73e8; color: #fff; }
#pager { display: flex; align-items: center; margin: 30px 0 44px; }
#pager button {
  display: flex; align-items: center; justify-content: center;
  width: 56px; height: 56px;
  border: none; border-radius: 8px;
  background: #000; color: #fff;
  font-size: 2.4rem;
  line-height: 0;                
  cursor: pointer;
}
.field {
  display: block; width: 100%; box-sizing: border-box;
  padding: 10px 12px; margin-top: 6px;
  font-size: 1rem;
  border: 1px solid #c8c8c8; border-radius: 6px;
  background: #fff;
  background-image: linear-gradient(#fff,#fff), linear-gradient(rgba(0,0,0,.06),rgba(0,0,0,.06));
  background-clip: content-box,border-box; box-shadow: 0 1px 2px rgba(0,0,0,.06);
  color: #888;
}
label { display: block; margin-top: 16px; margin-bottom: 28px; }
.select-wrap { position: relative; }
.select-wrap select.field {
  padding-right: 50px;
  appearance: none;
  background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 14 10'%3E%3Cpath fill='%23666' d='M7 10 0 0h14z'/%3E%3Csvg%3E") no-repeat right 14px center/22px 14px;
}
.select-wrap::after {
  content: '*'; color: red;
  position: absolute; right: 36px; top: 50%; transform: translateY(-50%);
  pointer-events: none; font-size: 1.1rem;
}
select option[data-ph].hide { display: none; }
.file-wrap { position: relative; }
.file-wrap input[type=file] { position: absolute; inset: 0; width: 100%; opacity: 0; cursor: pointer; }
.file-display {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 12px; border: 1px solid #c8c8c8; border-radius: 6px;
  background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,.06);
}
.file-display span {
    color: #888;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex-grow: 1; 
}
.file-display svg  { width: 22px; height: 22px; flex: none; }
textarea.field { resize: vertical; min-height: 70px; }
button[type=submit] {
  display: block; width: 100%; padding: 14px; margin-top: 22px;
  font-size: 1rem; font-weight: 600;
  background: #000; color: #fff; border: none; border-radius: 6px;
}
#msg    { margin-top: 14px; font-weight: 600; text-align: center; }
#thanks { display: none; padding: 60px 18px; text-align: center; font-size: 1rem; }
#thanks a { display: inline-block; margin-top: 24px; padding: 10px 18px; background: #1a73e8; color: #fff; text-decoration: none; border-radius: 6px; }
label .dt-number-1-label { color: #222 !important; } 
label .dt-number-2-label { color: #1565C0 !important; } 
label .dt-number-3-label { color: #2E7D32 !important; } 
label .dt-number-4-label { color: #BF360C !important; } 
</style>
</head>
<body>
<div id="wrap">
  <header id="hero">
    <div id="logoAndTitleContainer">
        <img src="https://sharkninja.com/wp-content/uploads/2024/02/SN-Logo-White-300x68.png"
              alt="SharkNinja logo">
        <span id="hero-title">Merchandiser Checklist</span>
    </div>
    <div id="langToggle">
        <button id="langEN" class="lang-btn active">EN</button>
        <button id="langAR" class="lang-btn">AR</button>
    </div>
  </header>
  <div class="after-hero"></div>
  <div id="tabBar"></div>
  <div id="pager">
    <button id="prevBtn">‹</button>
    <button id="nextBtn">›</button>
  </div>
  <form id="frm" novalidate>
    <div id="pagesContainer"></div>
    <div id="finalBlock" style="display:none">
        <label><span data-i18n-key="Additional Feedback (optional)">Additional Feedback (optional)</span>
            <textarea id="comments" class="field" rows="3" maxlength="260" data-i18n-placeholder="Type here…"></textarea>
        </label>
        <button type="submit" data-i18n-key="Submit">Submit</button>
    </div>
  </form>
  <div id="msg"></div>
  <div id="thanks">✅ <span data-i18n-key="Submission saved.">Submission saved.</span><br>
    <span data-i18n-key="Thank you!">Thank you!</span><br>
    <a href="" data-i18n-key="New entry">New entry</a>
  </div>
</div>
<script>
const translations = {
    en: {
        gate: '🛈 This checklist only works on <b>mobile phones</b>.',
        'Store Name': 'Store Name',
        'Display Type': 'Display Type',
        'Select your answer': 'Select your answer',
        'Take Photo': 'Take Photo',
        'Take Photo': 'Take Photo',
        'Photo Upload': 'Photo Upload',
        'Additional Feedback (optional)': 'Additional Feedback (optional)',
        'Submit': 'Submit',
        'Submission saved.': 'Submission saved.',
        'Thank you!': 'Thank you!',
        'New entry': 'New entry',
        'Type here…': 'Type here…',
        'Category Status': 'Category Status',
        'Select Status': 'Select your answer',
        'Out of Stock': 'Out of Stock',
        'Not Applicable': 'Not Applicable',
        Yes: 'Yes',
        No: 'No',
        '🟢 Good': '🟢 Good',
        '🟠 Fair': '🟠 Fair',
        '🔴 Poor': '🔴 Poor',
        Main: 'Main',
        'Floor Care': 'Floor Care',
        Blender: 'Blender',
        'Food Processor': 'Food Processor',
        'Hand Blender': 'Hand Blender',
        'Ice Cream Maker': 'Ice Cream Maker',
        Fan: 'Fan',
        'Air Fryer': 'Air Fryer',
        Grill: 'Grill',
        'Multi Cooker': 'Multi Cooker',
        Oven: 'Oven',
        'Hair Dryer': 'Hair Dryer',
        'Hair Styler': 'Hair Styler',
        Outdoor: 'Outdoor',
        'Outdoor Grill': 'Outdoor Grill',
        'Cooler Box': 'Cooler Box',
        'Shop in Shop': 'Shop in Shop',
        'End Cap': 'End Cap',
        'Countertop': 'Countertop',
        'Floor Display Unit': 'Floor Display Unit',
        'Display Cleanliness': 'Display Cleanliness',
        'Products Condition': 'Products Condition',
        'Product Facing Straight & Aligned': 'Product Facing Straight & Aligned',
        'Product / Signage Behind Led Strip': 'Product / Signage Behind Led Strip',
        'Required Signage Present?': 'Required Signage Present?',
        'Signage In Good Condition?': 'Signage In Good Condition?',
        'Pricing Tags Accurate & Visible?': 'Pricing Tags Accurate & Visible?',
        'Accessories Placed Behind Product?': 'Accessories Placed Behind Product?',
        'Any “Out of Stock” Products?': 'Any “Out of Stock” Products?',
        'Backup Stock Placed Correctly?': 'Backup Stock Placed Correctly?',
        'Any Damaged Products on Display?': 'Any Damaged Products on Display?',
    },
    ar: {
        gate: '🛈 قائمة التحقق هذه تعمل فقط على <b>الهواتف المحمولة</b>.',
        'Store Name': 'اسم المتجر',
        'Display Type': 'نوع العرض',
        'Select your answer': 'اختر إجابتك',
        'Take Photo': 'التقاط صورة',
        'Take Photo': 'تحميل صورة',
        'Photo Upload': 'تحميل صورة',
        'Additional Feedback (optional)': 'ملاحظات إضافية (اختياري)',
        'Submit': 'إرسال',
        'Submission saved.': 'تم حفظ الإرسال.',
        'Thank you!': 'شكرًا لك!',
        'New entry': 'إدخال جديد',
        'Type here…': 'اكتب هنا…',
        'Category Status': 'حالة الفئة',
        'Select Status': 'اختر إجابتك',
        'Out of Stock': 'غير متوفر',
        'Not Applicable': 'غير قابل للتطبيق',
        Yes: 'نعم',
        No: 'لا',
        '🟢 Good': 'جيد 🟢',
        '🟠 Fair': 'متوسط 🟠',
        '🔴 Poor': 'ضعيف 🔴',
        Main: 'الرئيسية',
        'Floor Care': 'العناية بالأرضيات',
        Blender: 'خلاط',
        'Food Processor': 'محضر طعام',
        'Hand Blender': 'خلاط يدوي',
        'Ice Cream Maker': 'صانعة الآيس كريم',
        'Fan': 'مروحة',
        'Air Fryer': 'قلاية هوائية',
        Grill: 'شواية',
        'Multi Cooker': 'طباخ متعدد',
        Oven: 'فرن',
        'Hair Dryer': 'مجفف شعر',
        'Hair Styler': 'مصفف شعر',
        Outdoor: 'خارجي',
        'Outdoor Grill': 'شواية خارجية',
        'Cooler Box': 'صندوق تبريد',
        'Shop in Shop': 'متجر داخل متجر',
        'End Cap': 'جناح طرفي',
        'Countertop': 'سطح الطاولة',
        'Floor Display Unit': 'وحدة عرض أرضية',
        'Display Cleanliness': 'نظافة العرض',
        'Products Condition': 'حالة المنتجات',
        'Product Facing Straight & Aligned': 'توجيه المنتجات بشكل صحيح',
        'Product / Signage Behind Led Strip': 'المنتج / اللافتات خلف شريط LED',
        'Required Signage Present?': 'هل توجد اللافتات المطلوبة؟',
        'Signage In Good Condition?': 'حالة اللافتات جيدة؟',
        'Pricing Tags Accurate & Visible?': 'بطاقات الأسعار دقيقة وواضحة؟',
        'Accessories Placed Behind Product?': 'هل وضعت الملحقات خلف المنتج؟',
        'Any “Out of Stock” Products?': 'هل هناك منتجات غير متوفرة؟',
        'Backup Stock Placed Correctly?': 'هل تم وضع المخزون الاحتياطي بشكل صحيح؟',
        'Any Damaged Products on Display?': 'هل هناك منتجات تالفة في العرض؟',
    }
};
let currentLang = 'en';
function translate(key) {
    return translations[currentLang][key] || key;
}
function applyTranslationsToStaticContent() {
    document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
    document.querySelectorAll('[data-i18n-key]').forEach(el => {
        if (el.id === 'hero-title') return; // Keep hero-title text fixed
        const key = el.dataset.i18nKey;
        // Only update innerHTML if it's not a numbered label span
        if (!el.matches('[class*="dt-number-"]')) {
            el.innerHTML = translate(key); 
        }
    });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        el.placeholder = translate(el.dataset.i18nPlaceholder);
    });
    document.querySelectorAll('#tabBar .tab').forEach(tab => {
        tab.textContent = translate(tab.dataset.originalPageName);
    });
}
const pagesContainer      = document.getElementById('pagesContainer');
const finalBlock          = document.getElementById('finalBlock');
const frm                 = document.getElementById('frm');
const msg                 = document.getElementById('msg');
const thanks              = document.getElementById('thanks');
const tabBar              = document.getElementById('tabBar');
const pager               = document.getElementById('pager');
const prevBtn             = document.getElementById('prevBtn');
const nextBtn             = document.getElementById('nextBtn');
const pages = [
    "Main", "Floor Care", "Blender", "Food Processor", "Hand Blender",
    "Ice Cream Maker", "Fan", "Air Fryer", "Grill", "Multi Cooker",
    "Oven", "Hair Dryer", "Hair Styler", "Outdoor", "Outdoor Grill", "Cooler Box"
];
let current = 0;
const pageContainers = {}; 
const slug = s => s.replace(/[^A-Za-z0-9]/g, '');
const to64 = f => new Promise(r => { const fr = new FileReader(); fr.onload = () => r(fr.result); fr.readAsDataURL(f) });
// type: 'select' for dropdowns, 'file' for photo uploads (though file inputs are handled separately for conditional logic)
const questionSpecs = {
    'Main': [
        {
            id: 'store', label: 'Store Name', type: 'select',
            options: [
                'Jeddah – eXtra – Prince Sultan',
                'Jeddah – eXtra – Tahlia',
                'Jeddah – eXtra – Alsafa',
                'Jeddah – eXtra – Jamea',
                'Jeddah – AAW – Tahlia',
                'Jeddah – Tamkeen – Prince Sultan'
            ],
            required: true,
            needsPhoto: () => false
        },
    ],
    'Floor Care': [  ],
    'Blender': [  ],
    'Food Processor': [  ],
    'Hand Blender': [  ],
    'Ice Cream Maker': [  ],
    'Fan': [  ],
    'Air Fryer': [  ],
    'Grill': [  ],
    'Multi Cooker': [  ],
    'Oven': [  ],
    'Hair Dryer': [  ],
    'Hair Styler': [  ],
    'Outdoor': [  ],
    'Outdoor Grill': [  ],
    'Cooler Box': [  ],
};
const commonDisplayTypeQuestions = [
    { id: 'DisplayCleanliness', label: 'Display Cleanliness', type: 'select', options: ['Yes', 'No'], required: true, needsPhoto: (v) => v === 'No' },
    { id: 'productCondition', label: 'Products Condition', type: 'select', options: ['🟢 Good', '🟠 Fair', '🔴 Poor'], required: true, needsPhoto: (v) => !v.startsWith('🟢') },
    { id: 'ProductFacingStraightAndAligned', label: 'Product Facing Straight & Aligned', type: 'select', options: ['Yes', 'No'], required: true, needsPhoto: (v) => v === 'No' },
    { id: 'ProductSignageBehindLedStrip', label: 'Product / Signage Behind LED Strip', type: 'select', options: ['Yes', 'No'], required: true, needsPhoto: (v) => v === 'No' },
    { id: 'signagePresent', label: 'Required Signage Present?', type: 'select', options: ['Yes', 'No'], required: true, needsPhoto: (v) => v === 'No' },
    { id: 'signageGood', label: 'Signage In Good Condition?', type: 'select', 'options': ['🟢 Good', '🟠 Fair', '🔴 Poor'], required: true, needsPhoto: (v) => !v.startsWith('🟢') },
    { id: 'pricingTagsOK', label: 'Pricing Tags Accurate & Visible?', type: 'select', options: ['Yes', 'No'], required: true, needsPhoto: (v) => v === 'No' },
    { id: 'accessoriesBehindProduct', label: 'Accessories Placed Behind Product?', type: 'select', options: ['Yes', 'No', 'Not Applicable'], required: true, needsPhoto: (v) => v === 'Yes' },
    { id: 'outOfStock', label: 'Any “Out of Stock” Products?', type: 'select', options: ['Yes', 'No'], required: true, needsPhoto: (v) => v === 'Yes' },
    { id: 'backupStockPlaced', label: 'Backup Stock Placed Correctly?', type: 'select', options: ['Yes', 'No'], required: true, needsPhoto: (v) => v === 'No' },
    { id: 'damagedDisplay', label: 'Any Damaged Products on Display?', type: 'select', options: ['Yes', 'No'], required: true, needsPhoto: (v) => v === 'Yes' },
];
for (let i = 1; i <= 4; i++) {
    questionSpecs.Main.push({
        id: `dtype${i}`, label: `Display Type`, 
        type: 'select',
        options: ['Shop in Shop', 'End Cap', 'Countertop', 'Floor Display Unit', 'Not Applicable'],
        required: (i === 1), 
        needsPhoto: (val) => val !== '' && val !== 'Not Applicable' // Needs photo if any choice other than empty or NA is selected
    });
    commonDisplayTypeQuestions.forEach(q => {
        questionSpecs.Main.push({
            id: `${q.id}${i}`, label: `${q.label}`, 
            type: q.type, options: q.options,
            required: false, 
            needsPhoto: q.needsPhoto
        });
    });
}
const commonSubPageQuestions = [
    { id: 'DisplayCleanliness', label: 'Display Cleanliness', type: 'select', options: ['Yes', 'No'], required: true, needsPhoto: () => false },
    { id: 'productCondition', label: 'Products Condition', type: 'select', options: ['🟢 Good', '🟠 Fair', '🔴 Poor'], required: true, needsPhoto: (v) => !v.startsWith('🟢') },
    { id: 'ProductFacingStraightAndAligned', label: 'Product Facing Straight & Aligned', type: 'select', options: ['Yes', 'No'], required: true, needsPhoto: () => false },
    { id: 'ProductSignageBehindLedStrip', label: 'Product / Signage Behind LED Strip', type: 'select', options: ['Yes', 'No'], required: true, needsPhoto: () => false },
    { id: 'signagePresent', label: 'Required Signage Present?', type: 'select', options: ['Yes', 'No'], required: true, needsPhoto: (v) => v === 'No' },
    { id: 'signageGood', label: 'Signage In Good Condition?', type: 'select', options: ['🟢 Good', '🟠 Fair', '🔴 Poor'], required: true, needsPhoto: (v) => !v.startsWith('🟢') },
    { id: 'pricingTagsOK', label: 'Pricing Tags Accurate & Visible?', type: 'select', options: ['Yes', 'No'], required: true, needsPhoto: () => false },
    { id: 'accessoriesBehindProduct', label: 'Accessories Placed Behind Product?', type: 'select', options: ['Yes', 'No', 'Not Applicable'], required: true, needsPhoto: (v) => v === 'Yes' },
    { id: 'outOfStock', label: 'Any “Out of Stock” Products?', type: 'select', options: ['Yes', 'No'], required: true, needsPhoto: (v) => v === 'Yes' },
    { id: 'backupStockPlaced', label: 'Backup Stock Placed Correctly?', type: 'select', options: ['Yes', 'No'], required: true, needsPhoto: () => false },
    { id: 'damagedDisplay', label: 'Any Damaged Products on Display?', type: 'select', options: ['Yes', 'No'], required: true, needsPhoto: (v) => v === 'Yes' },
];
pages.slice(1).forEach(pageName => {
    questionSpecs[pageName] = commonSubPageQuestions;
});
function buildAllPages() {
    tabBar.innerHTML = '';
    pagesContainer.innerHTML = ''; // Clear existing page containers
    pages.forEach((p, i) => {
        const t = document.createElement('div');
        t.textContent = translate(p);
        t.className = 'tab' + (i === current ? ' active' : '');
        t.dataset.originalPageName = p; 
        t.onclick = () => goPage(i);
        tabBar.appendChild(t);
        // Create container for each page's content
        const pageDiv = document.createElement('div');
        pageDiv.id = `page_${slug(p)}`;
        pageDiv.className = 'page-container';
        pageDiv.style.display = 'none'; // Hidden by default
        pagesContainer.appendChild(pageDiv);
        pageContainers[slug(p)] = pageDiv; 
        if (p === 'Main') {
            const mainContentDiv = document.createElement('div');
            mainContentDiv.id = 'mainContent'; // Container for all main page questions
            pageDiv.appendChild(mainContentDiv);
            const storeQuestion = questionSpecs.Main[0];
            const storeBlock = createQuestionHtml(storeQuestion, 'Main');
            mainContentDiv.appendChild(storeBlock);
            attachQuestionListeners(storeBlock, storeQuestion, 'Main');
            for (let dtNum = 1; dtNum <= 4; dtNum++) {
                const dtId = `dtype${dtNum}`;
                const dtQuestion = questionSpecs.Main.find(q => q.id === dtId);
                if (!dtQuestion) continue;
                const dtSectionId = `display_type_section_${dtNum}`;
                const dtSection = document.createElement('div');
                dtSection.id = dtSectionId;
                dtSection.style.display = 'none'; // Hidden by default, shown conditionally
                mainContentDiv.appendChild(dtSection);
                const dtLabelHtml = `<span class="dt-number-${dtNum}-label">${translate(dtQuestion.label)} ${dtNum}</span>`;
                const dtBlock = createQuestionHtml({ ...dtQuestion, label: dtLabelHtml }, 'Main', true); // Pass true for raw HTML label
                dtSection.appendChild(dtBlock);
                const wrapPhotoId = `wrap_cam_${dtId}`;
                const lblPhotoId = `lbl_cam_${dtId}`;
                const camPhotoId = `cam_${dtId}`;
                const photoHtml = `
                    <label style="margin-top: 8px;">
                        <span data-i18n-key="Take Photo">${translate('Take Photo')}</span>
                        <div class="file-wrap" id="${wrapPhotoId}" style="display:none;">
                            <div class="file-display">
                                <span id="${lblPhotoId}">${translate('Take Photo')}</span>
                                <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2">
                                    <circle cx="12" cy="13" r="4"></circle>
                                    <path d="M2 7h4l2-3h8l2 3h4v12H2z"></path>
                                </svg>
                            </div>
                            <input type="file" id="${camPhotoId}" accept="image/*" capture="environment">
                        </div>
                    </label>
                `;
                dtSection.insertAdjacentHTML('beforeend', photoHtml);
                const camPhoto = dtSection.querySelector(`#${camPhotoId}`); 
                const lblPhoto = dtSection.querySelector(`#${lblPhotoId}`); 
                camPhoto.onchange = () => {
                    lblPhoto.textContent = camPhoto.files[0] ? camPhoto.files[0].name : translate('Take Photo');
                    lblPhoto.style.color = camPhoto.files[0] ? '#000' : '#888';
                    markDone('Main');
                };
                commonDisplayTypeQuestions.forEach(qSpec => {
                    const commonQLabelHtml = `<span class="dt-number-${dtNum}-label">${translate(qSpec.label)} ${dtNum}</span>`;
                    const block = createQuestionHtml({ ...qSpec, label: commonQLabelHtml }, 'Main', true); // Pass true for raw HTML label
                    dtSection.appendChild(block);
                    attachQuestionListeners(block, { ...qSpec, id: `${qSpec.id}${dtNum}` }, 'Main'); // Use suffixed ID for listeners
                });
            }
            updateMainQuestionsVisibility(); 
            for (let dtNum = 1; dtNum <= 4; dtNum++) {
                const dtSelect = document.getElementById(`dtype${dtNum}`);
                if (dtSelect) {
                    dtSelect.onchange = () => {
                        dtSelect.style.color = '#000';
                        dtSelect.querySelector('[data-ph]')?.classList.add('hide');
                        updateMainQuestionsVisibility();
                        markDone('Main');
                    };
                }
            }
        } else {
            const s = slug(p);
            pageDiv.innerHTML = `
                <label>
                    <span data-i18n-key="Category Status">${translate('Category Status')}</span>
                    <div class="select-wrap">
                        <select id="status_photo_${s}" class="field page-status-selector" required data-page-name="${p}">
                            <option value="" disabled selected data-ph data-i18n-key="Select your answer">${translate('Select your answer')}</option>
                            <option value="Photo" data-i18n-key="Take Photo">${translate('Take Photo')}</option>
                            <option value="OOS" data-i18n-key="Out of Stock">${translate('Out of Stock')}</option>
                            <option value="Not Applicable" data-i18n-key="Not Applicable">${translate('Not Applicable')}</option>
                        </select>
                    </div>
                </label>
                <div id="sub_questions_${s}" style="display: none;">
                    <label><span data-i18n-key="Photo Upload">${translate('Photo Upload')}</span>
                        <div class="file-wrap" id="wrap_photo_${s}">
                            <div class="file-display">
                                <span id="lbl_photo_${s}">${translate('Take Photo')}</span>
                                <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2">
                                    <circle cx="12" cy="13" r="4"></circle><path d="M2 7h4l2-3h8l2 3h4v12H2z"></path>
                                </svg>
                            </div>
                            <input type="file" id="cam_photo_${s}" class="sub-question-field" accept="image/*" capture="environment" required>
                        </div>
                    </label>
                    <div id="category_specific_questions_${s}"></div>
                </div>
            `;
            const statusSelector = pageDiv.querySelector(`#status_photo_${s}`);
            const questionsDiv = pageDiv.querySelector(`#sub_questions_${s}`);
            const camMain = pageDiv.querySelector(`#cam_photo_${s}`);
            const lblMain = pageDiv.querySelector(`#lbl_photo_${s}`);
            const categorySpecificQuestionsContainer = pageDiv.querySelector(`#category_specific_questions_${s}`);
            statusSelector.onchange = (e) => {
                const pageName = e.target.dataset.pageName;
                const pageSlug = slug(pageName);
                const questionInputs = questionsDiv.querySelectorAll('.sub-question-field');
                if (e.target.value === 'Photo') {
                    questionsDiv.style.display = 'block';
                    const mainCatPhoto = pageDiv.querySelector(`#cam_photo_${pageSlug}`); 
                    if (mainCatPhoto) mainCatPhoto.required = true;
                    questionInputs.forEach(input => {
                        const originalRequired = input.dataset.originalRequired === 'true';
                        if (originalRequired) {
                            input.required = true;
                        }
                    });
                } else {
                    questionsDiv.style.display = 'none';
                    questionInputs.forEach(input => {
                        input.required = false;
                        if (input.type === 'file') input.value = '';
                        if (input.tagName === 'SELECT') {
                            input.value = '';
                            input.style.color = '#888';
                            const placeholderOption = input.querySelector('[data-ph]');
                            if (placeholderOption) placeholderOption.classList.remove('hide');
                        }
                    });
                    questionsDiv.querySelectorAll('.file-wrap').forEach(wrap => {
                        wrap.style.display = 'none';
                    });
                    const mainCatPhoto = pageDiv.querySelector(`#cam_photo_${pageSlug}`); 
                    if (mainCatPhoto) {
                        mainCatPhoto.required = false;
                        mainCatPhoto.value = '';
                        const lbl = pageDiv.querySelector(`#lbl_photo_${pageSlug}`); 
                        if (lbl) {
                            lbl.textContent = translate('Take Photo');
                            lbl.style.color = '#888';
                        }
                    }
                }
                markDone(pageName);
            };
            camMain.onchange = () => {
                lblMain.textContent = camMain.files[0] ? camMain.files[0].name : translate('Take Photo');
                lblMain.style.color = camMain.files[0] ? '#000' : '#888';
                markDone(p);
            };
            questionSpecs[p].forEach(qSpec => {
                const block = createQuestionHtml(qSpec, s); 
                categorySpecificQuestionsContainer.appendChild(block);
                attachQuestionListeners(block, qSpec, s); 
            });
        }
    });
    applyTranslationsToStaticContent();
    goPage(current);
}
function createQuestionHtml(qSpec, pageSlug, rawLabelHtml = false) {
    const uniqueId = pageSlug === 'Main' ? qSpec.id : `${pageSlug}_${qSpec.id}`;
    const lblID = `lbl_${uniqueId}`, camID = `cam_${uniqueId}`, wrapID = `wrap_${uniqueId}`;
    const isMainDisplayTypeSelect = qSpec.id.startsWith('dtype') && pageSlug === 'Main'; // Is this a Display Type X dropdown?
    const requiredAttr = qSpec.required ? `required data-original-required="true"` : `data-original-required="false"`;
    let labelHtmlContent;
    if (rawLabelHtml) {
        labelHtmlContent = qSpec.label;
    } else {
        labelHtmlContent = `<span data-i18n-key="${qSpec.label}">${translate(qSpec.label)}</span>`;
    }
    let html = `
        <label>
            ${labelHtmlContent}
            <div class="select-wrap">
                <select id="${uniqueId}" class="field ${pageSlug === 'Main' && !isMainDisplayTypeSelect ? '' : 'sub-question-field'}" ${requiredAttr}>
                    <option value="" disabled selected data-ph data-i18n-key="Select your answer">${translate('Select your answer')}</option>
                    ${qSpec.options.map(o => `<option value="${o}" data-i18n-key="${o}">${translate(o)}</option>`).join('')}
                </select>
            </div>
    `;
    if (!isMainDisplayTypeSelect) {
        html += `
            <div class="file-wrap" id="${wrapID}" style="display:none;margin-top:8px">
                <div class="file-display">
                    <span id="${lblID}">${translate('Take Photo')}</span>
                    <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2">
                        <circle cx="12" cy="13" r="4"></circle><path d="M2 7h4l2-3h8l2 3h4v12H2z"></path>
                    </svg>
                </div>
                <input type="file" id="${camID}" class="${pageSlug === 'Main' ? '' : 'sub-question-field'}" accept="image/*" capture="environment">
            </div>
        `;
    }
    html += `</label>`;
    const block = document.createElement('div'); // Use a div to wrap the label
    block.innerHTML = html;
    return block.firstElementChild; 
}
function attachQuestionListeners(blockElement, qSpec, pageSlug) {
    const uniqueId = pageSlug === 'Main' ? qSpec.id : `${pageSlug}_${qSpec.id}`;
    const sel = blockElement.querySelector(`#${uniqueId}`);
    const isMainDisplayTypeSelect = qSpec.id.startsWith('dtype') && pageSlug === 'Main';
    if (!sel) {
        console.error(`Element with ID ${uniqueId} not found.`);
        return;
    }
    sel.onchange = () => {
        sel.style.color = '#000';
        sel.querySelector('[data-ph]')?.classList.add('hide');
        if (!isMainDisplayTypeSelect) { 
            const wrap = blockElement.querySelector(`#wrap_${uniqueId}`);
            const file = blockElement.querySelector(`#cam_${uniqueId}`);
            const lbl = blockElement.querySelector(`#lbl_${uniqueId}`);
            if (qSpec.needsPhoto(sel.value)) {
                wrap.style.display = 'block';
                file.required = true;
            } else {
                wrap.style.display = 'none';
                file.required = false;
                file.value = '';
                lbl.textContent = translate('Take Photo');
                lbl.style.color = '#888';
            }
        }
        markDone(pageSlug === 'Main' ? 'Main' : pages[pages.indexOf(pages.find(p => slug(p) === pageSlug))]);
    };
    // Attach file input listener only if it's not a main display type photo, as those are handled in buildAllPages
    if (!isMainDisplayTypeSelect) {
        const file = blockElement.querySelector(`#cam_${uniqueId}`);
        const lbl = blockElement.querySelector(`#lbl_${uniqueId}`);
        if (file) {
            file.onchange = () => {
                lbl.textContent = file.files[0] ? file.files[0].name : translate('Take Photo');
                lbl.style.color = file.files[0] ? '#000' : '#888';
                markDone(pageSlug === 'Main' ? 'Main' : pages[pages.indexOf(pages.find(p => slug(p) === pageSlug))]);
            };
        }
    }
}
function goPage(i) {
    if (i < 0 || i >= pages.length) return;
    if (tabBar.children[current]) tabBar.children[current].classList.remove('active');
    if (tabBar.children[i]) tabBar.children[i].classList.add('active');
    current = i;
    Object.values(pageContainers).forEach(cont => cont.style.display = 'none');
    const currentPageName = pages[current];
    const currentPageSlug = slug(currentPageName);
    if (pageContainers[currentPageSlug]) {
        pageContainers[currentPageSlug].style.display = 'block';
    }
    // Special handling for Main page's internal structure
    if (currentPageName === 'Main') {
        updateMainQuestionsVisibility();
    }
    finalBlock.style.display = i === pages.length - 1 ? 'block' : 'none';
    prevBtn.style.display = i === 0 ? 'none' : 'flex';
    nextBtn.style.display = i === pages.length - 1 ? 'none' : 'flex';
    if (i === 0) pager.style.justifyContent = 'flex-end';
    else if (i === pages.length - 1) pager.style.justifyContent = 'flex-start';
    else pager.style.justifyContent = 'space-between';
    window.scrollTo({ top: 0, behavior: 'instant' });
}
prevBtn.onclick = () => goPage(current - 1);
nextBtn.onclick = () => goPage(current + 1);
function markDone(page) {
    const idx = pages.indexOf(page);
    if (idx < 0) return;
    const tab = tabBar.children[idx];
    let ok = true;
    const currentPageSlug = slug(page);
    const container = pageContainers[currentPageSlug];
    if (container) {
        if (page === 'Main') {
            const storeSelect = document.getElementById('store');
            if (!storeSelect.value) {
                ok = false;
            }
            for (let dtNum = 1; dtNum <= 4; dtNum++) {
                const dtSelect = document.getElementById(`dtype${dtNum}`);
                const dtSection = document.getElementById(`display_type_section_${dtNum}`);
                if (dtSelect && dtSection && dtSection.style.display !== 'none') {
                    if (!dtSelect.value) {
                        ok = false;
                        break; 
                    }
                    if (dtSelect.value !== 'Not Applicable') {
                        const camPhoto = dtSection.querySelector(`#cam_dtype${dtNum}`); 
                        if (camPhoto && camPhoto.required && !camPhoto.files.length) {
                            ok = false;
                            break;
                        }
                        commonDisplayTypeQuestions.forEach(qSpec => {
                            const el = dtSection.querySelector(`#${qSpec.id}${dtNum}`);
                            if (el && el.required && !el.value) {
                                ok = false;
                            }
                            if (qSpec.needsPhoto(el?.value)) {
                                const fileInput = dtSection.querySelector(`#cam_${qSpec.id}${dtNum}`); 
                                if (fileInput && fileInput.required && !fileInput.files.length) {
                                    ok = false;
                                }
                            }
                        });
                    }
                }
            }
        } else {
            const statusSelector = document.getElementById(`status_photo_${currentPageSlug}`);
            if (statusSelector) {
                if (statusSelector.value === 'OOS' || statusSelector.value === 'Not Applicable') {
                    ok = true;
                } else if (statusSelector.value === 'Photo') {
                    const questionsDiv = document.getElementById(`sub_questions_${currentPageSlug}`);
                    if (questionsDiv.style.display !== 'none') {
                        const camMain = questionsDiv.querySelector(`#cam_photo_${currentPageSlug}`); 
                        if (camMain && camMain.required && !camMain.files.length) {
                            ok = false;
                        }
                        for (const el of questionsDiv.querySelectorAll('.sub-question-field[data-original-required="true"]')) {
                            if (el.closest('.file-wrap[style*="display: none"]')) {
                                continue;
                            }
                            if (el.type === 'file') {
                                if (!el.files.length) ok = false;
                            } else {
                                if (!el.value) ok = false;
                            }
                        }
                        for (const qSpec of commonSubPageQuestions) {
                            const el = questionsDiv.querySelector(`#${currentPageSlug}_${qSpec.id}`);
                            if (el && qSpec.needsPhoto(el.value)) {
                                const fileInput = questionsDiv.querySelector(`#cam_${currentPageSlug}_${qSpec.id}`);
                                if (fileInput && fileInput.required && !fileInput.files.length) {
                                    ok = false;
                                }
                            }
                        }
                    } else {
                        ok = false;
                    }
                } else {
                    ok = false;
                }
            } else {
                ok = false;
            }
        }
    }
    if (tab) tab.classList.toggle('done', ok);
}
function updateMainQuestionsVisibility() {
    for (let dtNum = 1; dtNum <= 4; dtNum++) {
        const dtSelect  = document.getElementById(`dtype${dtNum}`);
        const dtSection = document.getElementById(`display_type_section_${dtNum}`);
        if (!dtSelect || !dtSection) continue;

        // Always show the section header so the user can answer the Display Type dropdown
        dtSection.style.display = 'block';

        // Everything except the first child (dropdown) are "extras"
        const extras = Array.from(dtSection.children).slice(1);
        const showExtras = dtSelect.value && dtSelect.value !== 'Not Applicable';

        extras.forEach(el => el.style.display = showExtras ? 'block' : 'none');

        // Dropdown itself must be answered
        dtSelect.required = true;

        // Manage 'required' and reset behaviour for inputs inside extras
        extras.forEach(el => {
            el.querySelectorAll('input, select, textarea').forEach(input => {
                if (showExtras) {
                    if (input.dataset.originalRequired === 'true') {
                        input.required = true;
                    }
                } else {
                    input.required = false;
                    if (input.type === 'file') {
                        input.value = '';
                        const lbl = el.querySelector('span[id^="lbl_"]');
                        if (lbl) {
                            lbl.textContent = translate('Take Photo');
                            lbl.style.color = '#888';
                        }
                    }
                    if (input.tagName === 'SELECT') {
                        input.value = '';
                        input.style.color = '#888';
                        const ph = input.querySelector('[data-ph]');
                        if (ph) ph.classList.remove('hide');
                    }
                }
            });
        });

        // Chain logic: show next Display Type section only if current one answered with a valid value
        const nextSection = document.getElementById(`display_type_section_${dtNum + 1}`);
        if (nextSection) {
            nextSection.style.display = showExtras ? 'block' : 'none';
        }
    }
    markDone('Main');
}
document.querySelectorAll('.lang-btn').forEach(btn => {
    btn.onclick = () => {
        const currentActiveBtn = document.querySelector('.lang-btn.active');
        if (currentActiveBtn) {
            currentActiveBtn.classList.remove('active');
        }
        btn.classList.add('active');
        currentLang = (btn.id === 'langAR') ? 'ar' : 'en';
        buildAllPages(); 
    };
});
let gps = { lat: '', lng: '' };
navigator.geolocation?.getCurrentPosition(
    p => { gps.lat = p.coords.latitude; gps.lng = p.coords.longitude; },
    console.warn, { timeout: 8000 });
frm.onsubmit = async e => {
    e.preventDefault();
    let tempRequiredElements = [];
    const currentPageName = pages[current];
    const currentPageSlug = slug(currentPageName);
    const currentPageContainer = pageContainers[currentPageSlug];
    if (currentPageContainer.style.display === 'block') {
        if (currentPageName === 'Main') {
            const storeSelect = document.getElementById('store');
            if (storeSelect.required && !storeSelect.value) tempRequiredElements.push(storeSelect);
            for (let dtNum = 1; dtNum <= 4; dtNum++) {
                const dtSelect = document.getElementById(`dtype${dtNum}`);
                const dtSection = document.getElementById(`display_type_section_${dtNum}`);
                if (dtSelect && dtSection && dtSection.style.display !== 'none') {
                    if (dtSelect.required && !dtSelect.value) {
                        tempRequiredElements.push(dtSelect);
                    }
                    if (dtSelect.value !== 'Not Applicable') {
                        const camPhoto = dtSection.querySelector(`#cam_dtype${dtNum}`); 
                        if (camPhoto && camPhoto.required && !camPhoto.files.length) {
                            tempRequiredElements.push(camPhoto);
                        }
                        commonDisplayTypeQuestions.forEach(qSpec => {
                            const el = dtSection.querySelector(`#${qSpec.id}${dtNum}`);
                            if (el && el.required && !el.value) {
                                tempRequiredElements.push(el);
                            }
                            if (qSpec.needsPhoto(el?.value)) {
                                const fileInput = dtSection.querySelector(`#cam_${qSpec.id}${dtNum}`);
                                if (fileInput && fileInput.required && !fileInput.files.length) {
                                    tempRequiredElements.push(fileInput);
                                }
                            }
                        });
                    }
                }
            }
        } else {
            const statusSelector = document.getElementById(`status_photo_${currentPageSlug}`);
            if (statusSelector.required && !statusSelector.value) tempRequiredElements.push(statusSelector);
            if (statusSelector.value === 'Photo') {
                const questionsDiv = document.getElementById(`sub_questions_${currentPageSlug}`);
                const camMain = questionsDiv.querySelector(`#cam_photo_${currentPageSlug}`); 
                if (camMain && camMain.required && !camMain.files.length) {
                    tempRequiredElements.push(camMain);
                }
                for (const el of questionsDiv.querySelectorAll('.sub-question-field[data-original-required="true"]')) {
                    if (el.closest('.file-wrap[style*="display: none"]')) {
                        continue;
                    }
                    if (el.type === 'file') {
                        if (!el.files.length) tempRequiredElements.push(el);
                    } else {
                        if (!el.value) tempRequiredElements.push(el);
                    }
                }
                for (const qSpec of commonSubPageQuestions) {
                    const el = questionsDiv.querySelector(`#${currentPageSlug}_${qSpec.id}`);
                    if (el && qSpec.needsPhoto(el.value)) {
                        const fileInput = questionsDiv.querySelector(`#cam_${currentPageSlug}_${qSpec.id}`);
                        if (fileInput && fileInput.required && !fileInput.files.length) {
                            tempRequiredElements.push(fileInput);
                        }
                    }
                }
            }
        }
    }
    tempRequiredElements.forEach(el => el.required = true);
    if (!frm.checkValidity()) {
        frm.reportValidity();
        tempRequiredElements.forEach(el => el.required = false);
        return;
    }
    tempRequiredElements.forEach(el => el.required = false);
    msg.textContent = 'Uploading…';
    const data = {
        store: document.getElementById('store').value,
        lat: gps.lat, lng: gps.lng,
        comments: document.getElementById('comments').value.trim(),
    };
    for (let dtNum = 1; dtNum <= 4; dtNum++) {
        const dtSelect = document.getElementById(`dtype${dtNum}`);
        const dtSection = document.getElementById(`display_type_section_${dtNum}`);
        if (dtSelect && dtSection && dtSection.style.display !== 'none') {
            const dtValue = dtSelect.value;
            data[`displayType${dtNum}`] = dtValue;
            if (dtValue && dtValue !== 'Not Applicable') { // Check if a value is selected and not NA
                const camPhoto = dtSection.querySelector(`#cam_dtype${dtNum}`); 
                if (camPhoto && camPhoto.files[0]) {
                    data[`mainDisplayPhoto${dtNum}`] = await to64(camPhoto.files[0]);
                } else {
                    data[`mainDisplayPhoto${dtNum}`] = ''; // Or 'N/A' if you prefer explicit
                }
                for (const qSpec of commonDisplayTypeQuestions) {
                    const id = `${qSpec.id}${dtNum}`;
                    const el = dtSection.querySelector(`#${id}`);
                    if (el) data[id] = el.value;
                    const f = dtSection.querySelector(`#cam_${id}`);
                    if (f && f.files[0]) data[`photo_${id}`] = await to64(f.files[0]);
                }
            } else {
                data[`mainDisplayPhoto${dtNum}`] = 'Not Applicable';
                commonDisplayTypeQuestions.forEach(qSpec => {
                    data[`${qSpec.id}${dtNum}`] = 'Not Applicable';
                    data[`photo_${qSpec.id}${dtNum}`] = 'Not Applicable';
                });
            }
        } else {
            data[`displayType${dtNum}`] = 'Not Applicable';
            data[`mainDisplayPhoto${dtNum}`] = 'Not Applicable';
            commonDisplayTypeQuestions.forEach(qSpec => {
                data[`${qSpec.id}${dtNum}`] = 'Not Applicable';
                data[`photo_${qSpec.id}${dtNum}`] = 'Not Applicable';
            });
        }
    }
    for (const pg of pages.slice(1)) {
        const s = slug(pg);
        const statusSelector = document.getElementById(`status_photo_${s}`);
        const status = statusSelector ? statusSelector.value : '';
        if (status === 'OOS' || status === 'Not Applicable') {
            data[`photo_${s}`] = status;
            questionSpecs[pg].forEach(qSpec => {
                data[`${s}_${qSpec.id}`] = status;
                data[`photo_${s}_${qSpec.id}`] = status;
            });
        } else if (status === 'Photo') {
            const cam = document.getElementById(`cam_photo_${s}`);
            if (cam && cam.files[0]) data[`photo_${s}`] = await to64(cam.files[0]);
            for (const qSpec of questionSpecs[pg]) {
                const id = `${s}_${qSpec.id}`;
                const el = document.getElementById(id); 
                if (el) {
                    data[id] = el.value || '';
                    const f = document.getElementById(`cam_${id}`); 
                    if (f && f.files[0]) data[`photo_${id}`] = await to64(f.files[0]);
                }
            }
        }
    }
    google.script.run.withSuccessHandler(() => {
        frm.style.display = 'none'; msg.style.display = 'none'; thanks.style.display = 'block';
    })
        .withFailureHandler(err => msg.textContent = '❌ ' + err.message)
        .submitForm(data);
};
buildAllPages();
</script>
</body>
</html>
